<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
  <title>生命游戏</title>
  <style>
    body {
      margin: 0;
    }
    #scene {
      position: fixed;
      width: 100vw;
      height: 100vh;
      background-color: #fff;
    }
    .img {
      position: absolute;
      width: 48px;
      height: 48px;
      pointer-events: none;
      transform: translateX(-50%) translateY(-50%);
    }
    .heart.beated {
      animation: shake 0.3s;
    }

    @keyframes shake {
      0% {
        transform: scaleX(1) translateX(0);
      }
      33% {
        transform: scaleX(1.5) translateX(-5px) translateY(5px);
      }
      66% {
        transform: scaleX(0.5) translateX(10px)  translateY(-10px);
      }
      100% {
        transform: scaleX(1);
      }
    }
  </style>
</head>
<body>
  <div id="scene"></div>
  <script>
    const posDic = {}
    const objDic = {}
    let heartCnt = 0;
    if (localStorage.isDead) alert('您已阵亡');
    scene.addEventListener('touchstart', function(ev){
      // 禁用默认事件
      ev.preventDefault();
      // 如果点到可操作区域，触发对应操作
      if (ev.target.className.indexOf('img') > -1) {
        ev.target.click()
      }
    }, true)
    const sceneConfig = {
      x: 0,
      y: 0
    }
    // 新手村的第一棵树
    create({type: 'tree', x: 50, y: 100})
    if (!localStorage.isDead) {
      create({type: 'heart', x: sceneConfig.x + 30, y: sceneConfig.y + 30})
      create({type: 'heart', x: sceneConfig.x + 80, y: sceneConfig.y + 30})
      create({type: 'heart', x: sceneConfig.x + 130, y: sceneConfig.y + 30})
      create({type: 'hero', x: 80, y: 100})
      create({type: 'enemy', x: 80, y: 100})
    }
    function create(config={}) {
      const { type } = config;
      const img = document.createElement('div');
      img.config = config;
      const id = Math.random().toString().substr(2);
      config.img = img;
      config.id = id;
      posDic[id] = config;
      objDic[id] = img;
      img.className = 'img type-'+type;
      if (config.x) img.style.left = `${config.x - sceneConfig.x}px`;
      if (config.y) img.style.top = `${config.y - sceneConfig.y}px`;
      if (config.y) img.style.zIndex = parseInt(config.y);
      if (config.w) img.style.width = `${config.w}px`;
      if (config.h) img.style.height = `${config.h}px`;
      img.destroy = function() {
        scene.removeChild(img);
        delete objDic[img.id];
      }
      switch(type) {
        case 'tree':
          img.style.background='url("img/tree.svg")';
          break;
        case 'enemy':
          img.style.background='url("img/tree.svg")';
          img.hurted = function() {
            img.destroy();
          }
          break;
        case 'hero':
          img.id="user";
          img.style.background='url("img/hero.svg")';
          img.locCb = function(x, y) {
            for (key in posDic) {
              const tarConfig = posDic[key];
              if (tarConfig.type === 'heart') {
                if (Math.abs(tarConfig.x - x) < 30 && Math.abs(tarConfig.y - y) < 30) {
                  tarConfig.img.click();
                }
              }
            }
          }
          img.hurted = function() {
            document.querySelector('.heart').click()
          }
          break;
        case 'heart':
          img.style.background='url("img/heartFull.svg")';
          img.classList.add('heart');
          heartCnt++;
          // 第一次被攻击
          img.onclick = function() {
            if (img.isBeating) return;
            img.isBeating = true;
            img.style.display = 'none';
            img.style.display = 'inline-block';
            img.classList.add('beated')
            window.heatBeatTimer = setTimeout(()=>{
              delete img.isBeating;
              img.classList.remove('beated');
              img.style.background = 'url("img/heartHalf.svg")';
              img.config.isBeated = img.config.isBeated || 0;
              img.config.isBeated++;
              if (img.config.isBeated >= 2) {
                img.style.display = 'none';
                img.className = img.className.replace(' heart', ' broken-heart')
                delete posDic[img.config.id];
                heartCnt--;
                if (heartCnt === 0) {
                  localStorage.isDead = 1;
                  alert('您已阵亡');
                  user.style.display = 'none';
                }
              }
            }, 300)
          }
          break;
        default:
      }
      scene.appendChild(img);
      return img
    }
  </script>
</div>
<link href="css/contrl.css" rel="stylesheet" >
<script src="js/event.js" type="text/javascript"></script>
<script src="js/contrl.js" type="text/javascript"></script>
</body>
</html>